---
- name: Install necessary programs
  tags: git,vim,nginx,certbot
  package:
    name: 
    - git
    - vim
    - nginx
    - certbot
    - python3-certbot-nginx
    state: latest
    update_cache: yes

- name: Start nginx
  service:
    name: nginx
    state: started

- name: Config for website
  template:
    src: "{{ website_config }}"
    dest: /etc/nginx/sites-available/{{ website_name }}

- name: create symlink
  file:
    src: /etc/nginx/sites-available/{{ website_name }}
    dest: /etc/nginx/sites-enabled/{{ website_name }}
    state: link

- name: restart nginx
  service:
    name: nginx
    state: restarted

- name: Register certbot
  shell: >
    certbot -n register --agree-tos --email chrberrig@protonmail.com
    touch /etc/letsencrypt/.registered
  args:
    creates: /etc/letsencrypt/.registered

- name: Setup cronjob for renewal
  cron:
    name: certbot-renewal
    minute: "0"
    hour: "14"
    job: "certbot -q renew'"

- name: Get certificate
  shell: certbot -n --nginx -d {{ domain }} -d www.{{ domain }}
  args:
    creates: /etc/letsencrypt/live/{{ domain }}
  ignore_errors: true

- name: clone git repo with website content
  git:
    repo: https://github.com/chrberrig/{{ website_name }}.git
    dest: /var/www/{{ website_name }}

- name: Set up crontab updating the website content from remote repo.
  cron: 
    name: "Update website from repo"
    minute: "*/5"
    job: git -C /var/www/{{ website_name }} pull
